#!/bin/bash

echo $1
echo $2

if [ "$OPENCL_ASE_SIM" == "1" ]; then
	#simulation programming flow(start VCS)
	if [[ "$1" != "acl0" ]] ; then
		echo "Not acl0, exiting without launching vcs"
		exit 0
	fi                                                                                     
	
	#uncompress and prepare modelsim files
	cp -rf $2 simulation.tar.gz
	mkdir -p temp_simulation
	cd temp_simulation
	tar zxvf $2 
	export KDIR=$PWD
	
	rm -fr ./ase
	cp -r $ASE_SRC_PATH ./ase
	cp -rf $AOCL_BOARD_PACKAGE_ROOT/ase/* ./ase
	cd ase
	
	mkdir dummy_rtl_dir
	touch dummy_rtl_dir/dummy_rtl_file.sv
	python ./scripts/generate_ase_environment.py dummy_rtl_dir
	
	bash run_sim.sh

else
	#HW programming, run aal configuration program
	#TODO: need to create custom reprogram utility so that we don't use this sample program.  Also using this path is a hack
	
	#reconfigure pll
	aocl binedit $2 get .acl.pll $2.pll
	$AOCL_BOARD_PACKAGE_ROOT/linux64/bin/aal_6.2.1_skx-p_user_clk.bin 0 0 $(cat $2.pll)
	RESULT=$?
	rm -rf $2.pll
	if [ ! $RESULT -eq 0 ]; then
		echo "ERROR: PLL failed to reconfigure"
		exit $RESULT
	fi
	
	#reprogram 
	aocl binedit $2 exists .acl.gbs.gz
	RESULT=$?
	
	if [ $RESULT -eq 0 ]; then
		aocl binedit $2 print .acl.gbs.gz | gzip -dc > $2.gbs
	else
		aocl binedit $2 get .acl.gbs $2.gbs
	fi
	
	$AALSDK/../aalsamples/ALI_Configure_AFU/SW/aliconfafu --force=TRUE --bitstream=$2.gbs
	RESULT=$?
	rm -rf $2.gbs 
	
	exit $RESULT
fi

